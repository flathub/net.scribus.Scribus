app-id: net.scribus.Scribus

runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk

command: scribus
rename-desktop-file: scribus.desktop
rename-appdata-file: scribus.appdata.xml
rename-icon: scribus

# Mark as beta
tags:
  - beta
desktop-file-name-suffix: ' (Beta)'

finish-args:
  # X11 + XShm access
  - --socket=x11
  - --share=ipc
  # Enable Wayland but keep X11 default for now
  - --socket=wayland
  - --env=QT_QPA_PLATFORM=xcb
  # Acceleration
  - --device=dri
  # Sound
  - --socket=pulseaudio
  # Ability to edit/save files anywhere
  - --filesystem=host
  # Printing
  - --socket=cups
  - --share=network

modules:
  - shared-modules/python2.7/python-2.7.json
  # The `tkinter` module is missing from the Freedesktop Sdk's Python installation.
  - name: tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/iwalton3/tkinter-standalone
        commit: ba946536054f9d27a08aafde21aa18330ce05729
    modules:
      - name: tcl
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtcl*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tcl8.6.13-src.tar.gz
            sha256: 43a1fae7412f61ff11de2cfd05d28cfc3a73762f354a417c62370a54e2caf066
            x-checker-data:
              type: anitya
              project-id: 4941
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz
      - name: tk
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtk*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tk8.6.12-src.tar.gz
            sha256: 12395c1f3fcb6bed2938689f797ea3cdf41ed5cb6c4766eec8ac949560310630
            x-checker-data:
              type: anitya
              project-id: 11426
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz

  - name: podofo
    buildsystem: cmake-ninja
    config-opts:
      - -DPODOFO_BUILD_LIB_ONLY=1
      - -DPODOFO_BUILD_SHARED=1
      - -DPODOFO_BUILD_STATIC=0
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/podofo/podofo/0.9.7/podofo-0.9.7.tar.gz
        sha256: 7cf2e716daaef89647c54ffcd08940492fd40c385ef040ce7529396bfadc1eb8
    cleanup:
      - /include
      - /lib/pkgconfig
      - /bin

  - name: graphicsmagick
    config-opts:
      - --enable-shared
      - --disable-static
      - --with-modules
      - --with-quantum-depth=16
      - --without-jpeg
      - --without-png
      - --without-tiff
      - --without-wmf
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/graphicsmagick/graphicsmagick/1.3.36/GraphicsMagick-1.3.36.tar.xz
        sha256: 5d5b3fde759cdfc307aaf21df9ebd8c752e3f088bb051dd5df8aac7ba7338f46
    cleanup:
      - /include
      - /lib/pkgconfig
      - /bin
      - /share/man
      - /share/doc
      - '*.la'

  - name: boost
    buildsystem: simple
    build-commands:
      - mkdir -p /app/include
      - mv boost /app/include
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.69.0/source/boost_1_69_0.tar.bz2
        sha256: 8f32d4617390d1c2d16f26a27ab60d97807b35440d45891fa340fc2648b04406
    cleanup:
      - '*'

  - name: poppler
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_UNSTABLE_API_ABI_HEADERS=ON
      - -DBUILD_GTK_TESTS=OFF
      - -DBUILD_QT5_TESTS=OFF
      - -DENABLE_UTILS=OFF
      - -DENABLE_GLIB=OFF
      - -DENABLE_QT5=OFF
    post-install:
      - cp poppler/poppler-config.h /app/include/poppler/goo
      - cp poppler/poppler-config.h /app/include/poppler/splash
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-21.12.0.tar.xz
        sha256: acb840c2c1ec07d07e53c57c4b3a1ff3e3ee2d888d44e1e9f2f01aaf16814de7
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'
    modules:
      - name: popplerdata
        no-autogen: true
        make-install-args:
          - prefix=/app
        sources:
          - type: archive
            url: https://poppler.freedesktop.org/poppler-data-0.4.10.tar.gz
            sha256: 6e2fcef66ec8c44625f94292ccf8af9f1d918b410d5aa69c274ce67387967b30
        cleanup:
          - /share/pkgconfig

  - name: ghostscript
    config-opts:
      - --with-system-libtiff
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      - --enable-dynamic
      - --with-drivers=FILES
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-9.54.0.tar.xz
        sha256: c2b7b43cde600f4e70efb2cd95865f6d884a67315c3de235914697d8ccde6e3b
      - type: shell
        commands:
          - rm -rf libpng/pngread.c
          - rm -rf tiff jpeg
    cleanup:
      - /share/man
      - /share/ghostscript/*/doc
      - /share/ghostscript/*/examples
      # This is horrible, all we want to do is leave one file
      - dvipdf
      - font2c
      - gsbj
      - gsdj500
      - gslp
      - lprsetup.sh
      - pdf2ps
      - pf2afm
      - printafm
      - ps2epsi
      - ps2pdfwr
      - ps2pdf13
      - ps2ps
      - wftopfa
      - eps2eps
      - gsdj
      - gslj
      - gsnd
      - pdf2dsc
      - pfbtopfa
      - pphs
      - ps2ascii
      - ps2pdf
      - ps2pdf12
      - ps2pdf14
      - ps2ps2
      - unix-lpr.sh

  - name: cppunit
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://dev-www.libreoffice.org/src/cppunit-1.14.0.tar.gz
        sha256: 3d569869d27b48860210c758c4f313082103a5e58219a7669b52bfd29d674780
    cleanup:
      - '*'

  - name: librevenge
    config-opts:
      - --without-docs
      - --disable-werror
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/libwpd/librevenge/librevenge-0.0.4/librevenge-0.0.4.tar.xz
        sha256: 933f0729f04267cc354b9a02bc3e9afefa5512a3bdd0b45f159ee14a3e3347b2
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'

  - name: libmspub
    config-opts:
      - --without-docs
      - --disable-tools
    sources:
      - type: archive
        url: https://dev-www.libreoffice.org/src/libmspub-0.1.4.tar.xz
        sha256: ef36c1a1aabb2ba3b0bedaaafe717bf4480be2ba8de6f3894be5fd3702b013ba
      - type: patch
        path: libmspub-0.1.4-gcc10.patch
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'

  - name: libcdr
    config-opts:
      - --without-docs
      - --disable-tools
      - --disable-werror
    sources:
      - type: archive
        url: https://dev-www.libreoffice.org/src/libcdr-0.1.7.tar.xz
        sha256: 5666249d613466b9aa1e987ea4109c04365866e9277d80f6cd9663e86b8ecdd4
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'

  - name: libvisio
    config-opts:
      - --without-docs
      - --disable-tools
    sources:
      - type: archive
        url: https://dev-www.libreoffice.org/src/libvisio-0.1.7.tar.xz
        sha256: 8faf8df870cb27b09a787a1959d6c646faa44d0d8ab151883df408b7166bea4c
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'

  - name: libpagemaker
    config-opts:
      - --without-docs
      - --disable-tools
      - --disable-werror
    sources:
      - type: archive
        url: https://dev-www.libreoffice.org/src/libpagemaker-0.0.4.tar.xz
        sha256: 66adacd705a7d19895e08eac46d1e851332adf2e736c566bef1164e7a442519d
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'

  - name: libfreehand
    config-opts:
      - --without-docs
      - --disable-tools
      - --disable-werror
    sources:
      - type: archive
        url: https://dev-www.libreoffice.org/src/libfreehand-0.1.2.tar.xz
        sha256: 0e422d1564a6dbf22a9af598535425271e583514c0f7ba7d9091676420de34ac
      - type: patch
        path: libfreehand-0.1.2-icu-fix.patch
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'

  - name: libqxp
    config-opts:
      - --without-docs
      - --disable-tools
    sources:
      - type: archive
        url: https://dev-www.libreoffice.org/src/libqxp-0.0.2.tar.xz
        sha256: e137b6b110120a52c98edd02ebdc4095ee08d0d5295a94316a981750095a945c
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'

  - name: libzmf
    config-opts:
      - --without-docs
      - --disable-tools
      - --disable-werror
    sources:
      - type: archive
        url: https://dev-www.libreoffice.org/src/libzmf-0.0.2.tar.xz
        sha256: 27051a30cb057fdb5d5de65a1f165c7153dc76e27fe62251cbb86639eb2caf22
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'

  - name: osg
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: git
        url: https://github.com/openscenegraph/OpenSceneGraph.git
        tag: OpenSceneGraph-3.6.5
        commit: a827840baf0786d72e11ac16d5338a4ee25779db

  - name: python3-Pillow
    buildsystem: simple
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/3e/02/b09732ca4b14405ff159c470a612979acfc6e8645dc32f83ea0129709f7a/Pillow-7.2.0.tar.gz
        sha256: 97f9e7953a77d5a70f49b9a48da7776dc51e9b738151b22dacf101641594a626
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST}
        Pillow

  - name: scribus
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DWANT_GRAPHICSMAGICK=1
    post-install:
      - mv /app/share/mime/packages/scribus.xml /app/share/mime/packages/net.scribus.Scribus.xml
      # Use system hyphen
      - rm -rf /app/share/scribus/dicts/hyph
      - ln -sf /usr/share/hyphen /app/share/scribus/dicts/hyph
      - rm -rf /app/share/icons/hicolor/1024x1024
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/scribus/scribus-devel/1.5.8/scribus-1.5.8.tar.xz
        sha256: 47816e8fcf6d05788ff16aa4499f97ff22431c777a7789149b0a88b451e16b74
      - type: shell
        commands:
          - sed -e 's|/usr/share/color/icc/|/run/host/usr/share/color/icc/|' -i scribus/scpaths.cpp
